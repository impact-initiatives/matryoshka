name: Run dbt in ACI
run-name: Run dbt build on ACI

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (default: latest)'
        required: false
        type: string
        default: 'latest'
      target:
        description: 'dbt target (dev or prod)'
        required: false
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      command:
        description: 'dbt command (default: build)'
        required: false
        type: string
        default: 'build'
  schedule:
    - cron: '0 2 * * *'

env:
  ACR_NAME: acrimpact
  IMAGE_NAME: matryoshka-dbt
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'switzerlandnorth' }}
  CONTAINER_NAME: matryoshka-dbt-${{ github.run_id }}
  IMAGE_TAG: ${{ inputs.image_tag || 'latest' }}
  DBT_TARGET: ${{ inputs.target || 'dev' }}
  DBT_COMMAND: ${{ inputs.command || 'build' }}

jobs:
  run-dbt:
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Azure Container Instance
        run: |
          az container create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --os-type Linux \
            --cpu ${{ vars.AZURE_CONTAINER_CPU || '2' }} \
            --memory ${{ vars.AZURE_CONTAINER_MEMORY || '4' }} \
            --restart-policy Never \
            --location ${{ env.AZURE_LOCATION }} \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --secure-environment-variables \
              DBT_DBNAME="${{ secrets.DBT_DBNAME }}" \
              DBT_HOST="${{ secrets.DBT_HOST }}" \
              DBT_USER="${{ secrets.DBT_USER }}" \
              DBT_PASSWORD="${{ secrets.DBT_PASSWORD }}" \
              DBT_SCHEMA_DEV="${{ vars.DBT_SCHEMA_DEV }}" \
              DBT_SCHEMA_PROD="${{ vars.DBT_SCHEMA_PROD }}" \
            --command-line "dbt ${{ env.DBT_COMMAND }} --target ${{ env.DBT_TARGET }}"

      - name: Follow container logs
        run: |
          echo "Following container logs..."
          for i in {1..30}; do
            STATE=$(az container show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.CONTAINER_NAME }} \
              --query "instanceView.state" -o tsv 2>/dev/null || echo "Pending")

            echo "Container state: $STATE"

            if [ "$STATE" = "Running" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ] || [ "$STATE" = "Terminated" ]; then
              break
            fi

            sleep 2
          done

          az container logs \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --follow &

          LOG_PID=$!

          while true; do
            STATE=$(az container show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.CONTAINER_NAME }} \
              --query "instanceView.state" -o tsv 2>/dev/null || echo "Unknown")

            if [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ] || [ "$STATE" = "Terminated" ]; then
              echo ""
              echo "Container finished with state: $STATE"
              kill $LOG_PID 2>/dev/null || true
              sleep 2
              break
            fi

            sleep 10
          done

      - name: Check container exit code
        if: always()
        run: |
          EXIT_CODE=$(az container show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --query "containers[0].instanceView.currentState.exitCode" -o tsv)

          echo "Container exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" != "0" ]; then
            echo "dbt run failed with exit code $EXIT_CODE"
            exit 1
          fi

      - name: Delete container
        if: always()
        run: |
          az container delete \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --yes
